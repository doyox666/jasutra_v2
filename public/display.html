<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Carwash - Display Antrian</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="./css/display.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Running Text -->
    <div class="running-text-container">
        <span class="running-text" id="runningText">Selamat Datang di JS Carwash - Jl. Raya Perumnas No.235, Sukaluyu, Teluk Jambe Timur, Karawang - Layanan Cuci Mobil & Detailing Profesional - Buka Setiap Hari 08:00 - 17:00 WIB</span>
    </div>
    
    <div class="header">
        <div class="header-left">
            <img src="./images/logo.png" alt="JS Carwash Logo" class="logo">
            <div class="header-title">
                <div class="welcome-text">JASUTRA CARWASH</div>
                <div class="address">Jl. Raya Perumnas No.235, Sukaluyu, Telukjambe Timur, Karawang, Jawa Barat 41361</div>
            </div>
        </div>
        <div class="datetime">
            <div class="time" id="clock-time">00:00:00</div>
            <div class="date" id="clock-date">1 Januari 2024</div>
        </div>
    </div>

    <div class="container">
        <!-- Section Cuci -->
        <div class="section">
            <div class="section-header">CUCI</div>
            <div class="queue-grid cuci-grid">
                <div class="queue-column">
                    <div class="column-header">
                        <i class="fas fa-car"></i>
                        <span>ANTRIAN</span>
                    </div>
                    <div id="cuci-waiting" class="queue-list">
                    </div>
                </div>
                <div class="queue-column">
                    <div class="column-header">
                        <i class="fas fa-shower"></i>
                        <span>CUCI</span>
                    </div>
                    <div id="cuci-washing" class="queue-list">
                    </div>
                </div>
                <div class="queue-column">
                    <div class="column-header">
                        <i class="fas fa-wind"></i>
                        <span>PENGERINGAN</span>
                    </div>
                    <div id="cuci-drying" class="queue-list">
                    </div>
                </div>
                <div class="queue-column">
                    <div class="column-header">
                        <i class="fas fa-check-circle"></i>
                        <span>SELESAI</span>
                    </div>
                    <div id="cuci-completed" class="queue-list">
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Detailing -->
        <div class="section">
            <div class="section-header">DETAILING</div>
            <div class="queue-grid detailing-grid">
                <div class="queue-column">
                    <div class="column-header">
                        <i class="fas fa-car"></i>
                        <span>Masuk Antrian</span>
                    </div>
                    <div id="detailing-waiting" class="queue-list">
                    </div>
                </div>
                <div class="queue-column">
                    <div class="column-header">
                        <i class="fas fa-magic"></i>
                        <span>Detailing</span>
                    </div>
                    <div id="detailing-process" class="queue-list">
                    </div>
                </div>
                <div class="queue-column">
                    <div class="column-header">
                        <i class="fas fa-check-circle"></i>
                        <span>Selesai</span>
                    </div>
                    <div id="detailing-completed" class="queue-list">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        // Update clock with proper formatting
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeString = `${hours}.${minutes}.${seconds}`;
            
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const dateString = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            
            document.getElementById('clock-time').textContent = timeString;
            document.getElementById('clock-date').textContent = dateString;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Load active queues
        async function loadQueues() {
            try {
                const response = await fetch('/api/queue/active');
                const data = await response.json();
                updateQueueDisplay(data);
            } catch (error) {
                console.error('Error loading queues:', error);
            }
        }

        // Update queue display
        function updateQueueDisplay(data) {
            // Clear all queue lists
            const lists = document.querySelectorAll('.queue-list');
            lists.forEach(list => {
                list.innerHTML = '';
            });

            // Process cuci queues
            data.cuci.forEach(vehicle => {
                let targetId;
                switch(vehicle.status) {
                    case 'waiting':
                        targetId = 'cuci-waiting';
                        break;
                    case 'washing':
                        targetId = 'cuci-washing';
                        break;
                    case 'drying':
                        targetId = 'cuci-drying';
                        break;
                    case 'completed':
                        targetId = 'cuci-completed';
                        break;
                }
                if (targetId) {
                    addQueueItem(targetId, vehicle, 'cuci');
                }
            });

            // Process detailing queues with 3 item limit per column
            const detailingColumns = {
                'detailing-waiting': 0,
                'detailing-process': 0,
                'detailing-completed': 0
            };
            
            data.detailing.forEach(vehicle => {
                let targetId;
                switch(vehicle.status) {
                    case 'waiting':
                        targetId = 'detailing-waiting';
                        break;
                    case 'detailing':
                        targetId = 'detailing-process';
                        break;
                    case 'completed':
                        targetId = 'detailing-completed';
                        break;
                }
                if (targetId && detailingColumns[targetId] < 3) {
                    addQueueItem(targetId, vehicle, 'detailing');
                    detailingColumns[targetId]++;
                }
            });
            
        }

        // Add queue item to display
        function addQueueItem(targetId, vehicle, serviceType) {
            const container = document.getElementById(targetId);
            
            if (!container) return;
            

            const item = document.createElement('div');
            item.className = `queue-item ${serviceType}`;
            item.setAttribute('data-status', vehicle.status);
            item.innerHTML = `
                <div class="queue-number">${vehicle.queue_number}</div>
                <div class="plate-number">${vehicle.plate_number}</div>
            `;
            container.appendChild(item);
        }

        // Socket event listeners
        socket.on('queueUpdate', (data) => {
            loadQueues();
        });

        socket.on('dailyReset', (data) => {
            loadQueues();
        });

        // Load running text from API
        async function loadRunningText() {
            try {
                const response = await fetch('/api/queue/running-text');
                const data = await response.json();
                document.getElementById('runningText').textContent = data.text;
            } catch (error) {
                console.error('Error loading running text:', error);
            }
        }

        // Socket listener for running text updates
        socket.on('runningTextUpdate', (data) => {
            document.getElementById('runningText').textContent = data.text;
        });

        // Initial load
        loadQueues();
        loadRunningText();

        // Refresh every 30 seconds as backup
        setInterval(() => {
            loadQueues();
        }, 30000);
    </script>
</body>
</html>