<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS Carwash - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="./css/admin.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><img src="./images/logo.png" alt="JS Carwash Logo" class="logo"> JS CARWASH</h2>
        </div>
        <ul class="nav-menu">
            <li class="nav-item active" data-section="dashboard">
                <i class="fas fa-chart-line"></i> Dashboard
            </li>
            <li class="nav-item" data-section="registration">
                <i class="fas fa-plus-circle"></i> Pendaftaran
            </li>
            <li class="nav-item" data-section="queue">
                <i class="fas fa-car"></i> Kelola Antrian
            </li>
            <li class="nav-item" data-section="report">
                <i class="fas fa-chart-bar"></i> Report
            </li>
            <li class="nav-item" data-section="activity">
                <i class="fas fa-history"></i> Activity Log
            </li>
            <li class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i> Settings
            </li>
        </ul>
        <div style="padding: 20px; margin-top: auto; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <a href="/" target="_blank" class="btn-display-view">
                <i class="fas fa-desktop"></i> Tampilan Pengunjung
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="header">
                <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                <div>
                    <i class="far fa-clock"></i> <span id="currentDateTime"></span>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-calendar-day" style="color: #667eea; font-size: 2em;"></i></div>
                    <div class="stat-label">Total Hari Ini</div>
                    <div class="stat-value" id="stat-today">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle" style="color: #28a745; font-size: 2em;"></i></div>
                    <div class="stat-label">Selesai</div>
                    <div class="stat-value" id="stat-completed">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock" style="color: #ffc107; font-size: 2em;"></i></div>
                    <div class="stat-label">Menunggu</div>
                    <div class="stat-value" id="stat-waiting">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-spinner fa-pulse" style="color: #17a2b8; font-size: 2em;"></i></div>
                    <div class="stat-label">Dalam Proses</div>
                    <div class="stat-value" id="stat-progress">0</div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-list"></i> Antrian Aktif Hari Ini</h3>
                <table class="table" id="todayQueueTable">
                    <thead>
                        <tr>
                            <th>No. Antrian</th>
                            <th>Plat Nomor</th>
                            <th>Jenis</th>
                            <th>Status</th>
                            <th>Waktu Masuk</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Registration Section -->
        <div id="registration" class="content-section">
            <div class="header">
                <h1><i class="fas fa-plus-circle"></i> Pendaftaran Kendaraan</h1>
            </div>

            <div class="card">
                <form id="registrationForm">
                    <div class="form-group">
                        <label for="plateNumber">Plat Nomor *</label>
                        <input type="text" class="form-control" id="plateNumber" required 
                               placeholder="Contoh: B 1234 ABC" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label for="serviceType">Jenis Layanan *</label>
                        <select class="form-control" id="serviceType" required>
                            <option value="">-- Pilih Layanan --</option>
                            <option value="cuci">Cuci Mobil</option>
                            <option value="detailing">Detailing</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Daftarkan Kendaraan & Cetak Struk
                    </button>
                </form>
            </div>

        </div>

        <!-- Queue Management Section -->
        <div id="queue" class="content-section">
            <div class="header">
                <h1><i class="fas fa-car"></i> Kelola Antrian</h1>
            </div>

            <div class="card">
                <h3><i class="fas fa-car-side"></i> Kendaraan Terdaftar Hari Ini</h3>
                <table class="table" id="registeredTable">
                    <thead>
                        <tr>
                            <th>No. Antrian</th>
                            <th>Plat Nomor</th>
                            <th>Jenis</th>
                            <th>Status Saat Ini</th>
                            <th>Waktu Daftar</th>
                            <th style="min-width: 250px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Report Section -->
        <div id="report" class="content-section">
            <div class="header">
                <h1><i class="fas fa-chart-bar"></i> Report</h1>
            </div>

            <div class="card">
                <h3><i class="fas fa-filter"></i> Filter Report</h3>
                <form id="reportForm">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label for="reportStartDate">Tanggal Mulai</label>
                            <input type="date" class="form-control" id="reportStartDate">
                        </div>
                        <div class="form-group">
                            <label for="reportEndDate">Tanggal Akhir</label>
                            <input type="date" class="form-control" id="reportEndDate">
                        </div>
                        <div class="form-group">
                            <label for="reportServiceType">Jenis Layanan</label>
                            <select class="form-control" id="reportServiceType">
                                <option value="all">Semua</option>
                                <option value="cuci">Cuci Mobil</option>
                                <option value="detailing">Detailing</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Tampilkan Report
                        </button>
                        <button type="button" class="btn btn-success" id="exportExcel">
                            <i class="fas fa-file-excel"></i> Export ke Excel
                        </button>
                    </div>
                </form>
            </div>

            <div class="card" id="reportSummary" style="display: none;">
                <h3><i class="fas fa-chart-pie"></i> Ringkasan Report</h3>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">Total Kendaraan</div>
                        <div class="stat-value" id="report-total">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cuci Mobil</div>
                        <div class="stat-value" id="report-cuci">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Detailing</div>
                        <div class="stat-value" id="report-detailing">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rata-rata Waktu</div>
                        <div class="stat-value" id="report-avg-time">0</div>
                    </div>
                </div>
            </div>

            <div class="card" id="reportData" style="display: none;">
                <h3><i class="fas fa-database"></i> Data Kendaraan</h3>
                <table class="table" id="reportTable">
                    <thead>
                        <tr>
                            <th>No. Antrian</th>
                            <th>Plat Nomor</th>
                            <th>Jenis</th>
                            <th>Status</th>
                            <th>Waktu Masuk</th>
                            <th>Waktu Selesai</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Activity Log Section -->
        <div id="activity" class="content-section">
            <div class="header">
                <h1><i class="fas fa-history"></i> Activity Log</h1>
            </div>

            <div class="card">
                <h3><i class="fas fa-stream"></i> Aktivitas Sistem</h3>
                <table class="table" id="activityTable">
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Kendaraan</th>
                            <th>Aksi</th>
                            <th>Deskripsi</th>
                            <th>User</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-primary" id="loadMoreActivity">
                        <i class="fas fa-plus"></i> Muat Lebih Banyak
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section">
            <div class="header">
                <h1><i class="fas fa-cog"></i> Settings</h1>
            </div>

            <div class="card">
                <h3><i class="fas fa-scroll"></i> Running Text</h3>
                <form id="runningTextForm">
                    <div class="form-group">
                        <label for="runningTextInput">Teks Berjalan</label>
                        <textarea class="form-control" id="runningTextInput" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> Update Running Text
                    </button>
                </form>
            </div>

            <div class="card">
                <h3><i class="fas fa-undo-alt"></i> Reset Nomor Antrian</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Nomor antrian akan otomatis reset setiap hari pukul 00:01. 
                    Gunakan tombol di bawah untuk reset manual jika diperlukan.
                </p>
                <form id="resetQueueForm">
                    <div class="form-group">
                        <label for="resetPassword">Password Admin</label>
                        <input type="password" class="form-control" id="resetPassword" 
                               placeholder="Masukkan password untuk reset" required>
                    </div>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-redo"></i> Reset Nomor Antrian Sekarang
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Print Receipt Modal -->
    <div id="printModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal">&times;</span>
                <h2 class="modal-title">Struk Antrian</h2>
            </div>
            <div id="printContent" class="print-receipt"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Cetak Struk
                </button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentSection = 'dashboard';
        let activityOffset = 0;
        
        // Audio notification system for admin
        let isAudioEnabled = false;
        let audioContext = null;
        
        // Initialize audio context
        function initializeAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                isAudioEnabled = true;
                console.log('Admin audio context initialized');
            } catch (error) {
                console.warn('Web Audio API not supported:', error);
                isAudioEnabled = false;
            }
        }
        
        // Play notification beep sound
        function playNotificationBeep() {
            if (!isAudioEnabled || !audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.warn('Error playing beep sound:', error);
            }
        }
        
        // Convert plate number to spell out each character
        function spellOutPlateNumber(plateNumber) {
            const numberMap = {
                '0': 'nol',
                '1': 'satu',
                '2': 'dua', 
                '3': 'tiga',
                '4': 'empat',
                '5': 'lima',
                '6': 'enam',
                '7': 'tujuh',
                '8': 'delapan',
                '9': 'sembilan'
            };
            
            return plateNumber
                .split('')
                .map(char => {
                    if (char === ' ') {
                        return ' '; // Keep spaces
                    } else if (numberMap[char]) {
                        return numberMap[char]; // Convert numbers
                    } else {
                        return char.toUpperCase(); // Keep letters as uppercase
                    }
                })
                .join(' '); // Add space between each character
        }
        
        // Text-to-speech announcement for admin
        function announceCustomer(plateNumber) {
            if (!('speechSynthesis' in window)) {
                console.warn('Text-to-speech not supported');
                return;
            }
            
            try {
                // Stop any ongoing speech
                speechSynthesis.cancel();
                
                // Convert plate number to spell out each character
                const spelledPlateNumber = spellOutPlateNumber(plateNumber);
                
                // Get voice
                const voices = speechSynthesis.getVoices();
                const indonesianVoice = voices.find(voice => 
                    voice.lang.includes('id') || voice.name.includes('Indonesia')
                );
                
                // First announcement - plate number (slower)
                const plateUtterance = new SpeechSynthesisUtterance(spelledPlateNumber);
                plateUtterance.lang = 'id-ID';
                plateUtterance.volume = 0.8;
                plateUtterance.rate = 0.7; // Slower for plate number clarity
                plateUtterance.pitch = 1.0;
                if (indonesianVoice) plateUtterance.voice = indonesianVoice;
                
                // Second part - "telah selesai" (faster)
                plateUtterance.onend = () => {
                    const completionUtterance = new SpeechSynthesisUtterance('telah selesai');
                    completionUtterance.lang = 'id-ID';
                    completionUtterance.volume = 0.8;
                    completionUtterance.rate = 1.1; // Faster for "telah selesai"
                    completionUtterance.pitch = 1.0;
                    if (indonesianVoice) completionUtterance.voice = indonesianVoice;
                    
                    // Third part - repeat plate number and completion
                    completionUtterance.onend = () => {
                        setTimeout(() => {
                            const repeatPlateUtterance = new SpeechSynthesisUtterance(spelledPlateNumber);
                            repeatPlateUtterance.lang = 'id-ID';
                            repeatPlateUtterance.volume = 0.8;
                            repeatPlateUtterance.rate = 0.7; // Slower for plate number
                            repeatPlateUtterance.pitch = 1.0;
                            if (indonesianVoice) repeatPlateUtterance.voice = indonesianVoice;
                            
                            repeatPlateUtterance.onend = () => {
                                const finalCompletionUtterance = new SpeechSynthesisUtterance('telah selesai');
                                finalCompletionUtterance.lang = 'id-ID';
                                finalCompletionUtterance.volume = 0.8;
                                finalCompletionUtterance.rate = 0.9; // Faster for "telah selesai"
                                finalCompletionUtterance.pitch = 1.0;
                                if (indonesianVoice) finalCompletionUtterance.voice = indonesianVoice;
                                
                                speechSynthesis.speak(finalCompletionUtterance);
                            };
                            
                            speechSynthesis.speak(repeatPlateUtterance);
                        }, 300); // Short pause before repeat
                    };
                    
                    speechSynthesis.speak(completionUtterance);
                };
                
                speechSynthesis.speak(plateUtterance);
                console.log(`Admin announcing: ${spelledPlateNumber} telah selesai`);
            } catch (error) {
                console.warn('Error in text-to-speech:', error);
            }
        }
        
        // Call customer function
        function callCustomer(plateNumber, serviceType) {
            // Initialize audio if not already done
            if (!audioContext) {
                initializeAudio();
            }
            
            // Show confirmation with audio option
            const serviceText = serviceType === 'cuci' ? 'Cuci Mobil' : 'Detailing';
            const shouldPlayAudio = confirm(`🔊 Panggil Customer\n\nPlat Nomor: ${plateNumber}\nLayanan: ${serviceText}\n\nKlik OK untuk panggil dengan pengumuman suara\nKlik Cancel untuk batal`);
            
            if (shouldPlayAudio) {
                // Show immediate feedback
                showNotification(`Memanggil customer ${plateNumber}...`, 'info');
                
                // Play notification sound
                setTimeout(() => {
                    playNotificationBeep();
                }, 200);
                
                // Announce customer
                setTimeout(() => {
                    announceCustomer(plateNumber);
                }, 800);
                
                // Show success notification
                setTimeout(() => {
                    showNotification(`✅ Customer ${plateNumber} telah dipanggil!\n🔊 Pengumuman telah diputar`, 'success');
                }, 2000);
                
                // Log activity for this action
                setTimeout(() => {
                    logCustomerCall(plateNumber, serviceType);
                }, 2500);
            }
        }
        
        // Log customer call activity (optional)
        function logCustomerCall(plateNumber, serviceType) {
            try {
                // This could be enhanced to log to backend if needed
                console.log(`Customer called: ${plateNumber} (${serviceType}) at ${new Date().toLocaleString('id-ID')}`);
            } catch (error) {
                console.warn('Error logging customer call:', error);
            }
        }
        
        // Initialize audio on first user interaction
        document.addEventListener('click', () => {
            if (!audioContext) {
                initializeAudio();
            }
        }, { once: true });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                showSection(section);
            });
        });

        function showSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            document.getElementById(section).classList.add('active');
            currentSection = section;

            // Load section data
            if (section === 'dashboard') {
                loadDashboard();
            } else if (section === 'registration') {
                // No need to load anything extra for registration
            } else if (section === 'queue') {
                loadRegistered(); // Load registered vehicles for queue management
            } else if (section === 'activity') {
                loadActivityLog();
            } else if (section === 'settings') {
                loadSettings();
            }
        }

        // Update date/time
        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            });
            document.getElementById('currentDateTime').textContent = dateTimeString + ' WIB';
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Load Dashboard
        async function loadDashboard() {
            try {
                // Load statistics
                const statsResponse = await fetch('/api/admin/statistics');
                const stats = await statsResponse.json();
                
                document.getElementById('stat-today').textContent = stats.today_total;
                document.getElementById('stat-completed').textContent = stats.today_completed;
                document.getElementById('stat-waiting').textContent = stats.today_waiting;
                document.getElementById('stat-progress').textContent = stats.today_in_progress;

                // Load today's vehicles
                const vehiclesResponse = await fetch('/api/admin/vehicles/today');
                const vehicles = await vehiclesResponse.json();
                
                const tbody = document.querySelector('#todayQueueTable tbody');
                tbody.innerHTML = '';
                
                vehicles.forEach(vehicle => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${vehicle.queue_number}</td>
                        <td>${vehicle.plate_number}</td>
                        <td>${vehicle.service_type === 'cuci' ? 'Cuci Mobil' : 'Detailing'}</td>
                        <td><span class="badge badge-${vehicle.status}">${getStatusText(vehicle.status)}</span></td>
                        <td>${formatDateTime(vehicle.created_at, true)}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Registration Form
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const plateNumber = document.getElementById('plateNumber').value;
            const serviceType = document.getElementById('serviceType').value;
            
            try {
                const response = await fetch('/api/queue/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plate_number: plateNumber, service_type: serviceType })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show print modal
                    showPrintReceipt(result.vehicle);
                    
                    // Clear form
                    document.getElementById('registrationForm').reset();
                    
                    // Reload registered vehicles
                    loadRegistered();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error registering vehicle:', error);
                alert('Error registering vehicle');
            }
        });

        // Show print receipt
        function showPrintReceipt(vehicle) {
            const printContent = document.getElementById('printContent');
            const now = new Date();
            printContent.innerHTML = `
                <div class="receipt-header">
                    JS CARWASH<br>
                    Jl. Raya Perumnas No.235<br>
                    Sukaluyu, Teluk Jambe Timur<br>
                    Karawang
                </div>
                <hr>
                <div class="receipt-number">
                    ${vehicle.queue_number}
                </div>
                <div>
                    Plat: ${vehicle.plate_number}<br>
                    Layanan: ${vehicle.service_type === 'cuci' ? 'Cuci Mobil' : 'Detailing'}<br>
                    Waktu: ${formatDateTime(vehicle.created_at)}
                </div>
                <hr>
                <div class="receipt-footer">
                    Terima kasih atas kunjungan Anda<br>
                    Struk ini adalah sebagai<br>
                    bukti antrian
                </div>
            `;
            
            document.getElementById('printModal').classList.add('active');
        }

        // Close modal
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.getElementById('printModal').classList.remove('active');
        });

        // Load registered vehicles
        async function loadRegistered() {
            try {
                const response = await fetch('/api/admin/vehicles');
                const vehicles = await response.json();
                
                const tbody = document.querySelector('#registeredTable tbody');
                tbody.innerHTML = '';
                
                vehicles.forEach(vehicle => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${vehicle.queue_number}</td>
                        <td>${vehicle.plate_number}</td>
                        <td>${vehicle.service_type === 'cuci' ? 'Cuci Mobil' : 'Detailing'}</td>
                        <td><span class="badge badge-${vehicle.status}">${getStatusText(vehicle.status)}</span></td>
                        <td>${formatDateTime(vehicle.created_at, true)}</td>
                        <td>
                            <div class="action-buttons">
                                <select class="form-control form-control-sm" onchange="updateVehicleStatus(${vehicle.id}, this.value)" style="width: auto; display: inline-block;">
                                    <option value="">-- Ubah Status --</option>
                                    ${getStatusOptions(vehicle.service_type, vehicle.status)}
                                </select>
                                <button class="btn btn-sm btn-info" onclick="reprintReceipt(${JSON.stringify(vehicle).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-print"></i> Cetak
                                </button>
                                ${vehicle.service_type === 'cuci' && vehicle.status !== 'completed' ? `
                                    <button class="btn btn-sm btn-warning" onclick="moveToDetailing(${vehicle.id}, '${vehicle.queue_number}', '${vehicle.plate_number}')">
                                        <i class="fas fa-exchange-alt"></i> Pindah ke Detailing
                                    </button>
                                ` : ''}
                                ${vehicle.status === 'completed' ? `
                                    <button class="btn btn-sm btn-success call-customer-btn" onclick="callCustomer('${vehicle.plate_number}', '${vehicle.service_type}')" title="🔊 Panggil Customer ${vehicle.plate_number} dengan pengumuman suara">
                                        <i class="fas fa-bullhorn"></i> Panggil
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteVehicle(${vehicle.id}, '${vehicle.queue_number}', '${vehicle.plate_number}')">
                                        <i class="fas fa-trash"></i> Hapus
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading registered vehicles:', error);
            }
        }

        // Reprint receipt
        function reprintReceipt(vehicle) {
            showPrintReceipt(vehicle);
        }


        // Get status options based on service type
        function getStatusOptions(serviceType, currentStatus) {
            const options = [];
            
            if (serviceType === 'cuci') {
                if (currentStatus === 'waiting') {
                    options.push('<option value="washing">Mulai Cuci</option>');
                }
                if (currentStatus === 'washing') {
                    options.push('<option value="drying">Mulai Pengeringan</option>');
                }
                if (currentStatus === 'drying') {
                    options.push('<option value="completed">Selesai</option>');
                }
            } else {
                if (currentStatus === 'waiting') {
                    options.push('<option value="detailing">Mulai Detailing</option>');
                }
                if (currentStatus === 'detailing') {
                    options.push('<option value="completed">Selesai</option>');
                }
            }
            
            if (currentStatus !== 'completed') {
                options.push('<option value="completed">Selesai Langsung</option>');
            }
            
            return options.join('');
        }

        // Update vehicle status
        async function updateVehicleStatus(vehicleId, newStatus) {
            if (!newStatus) return;
            
            try {
                const response = await fetch(`/api/queue/${vehicleId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success notification
                    showNotification('Status berhasil diperbarui!', 'success');
                    
                    // Reload appropriate section based on current view
                    if (currentSection === 'queue') {
                        loadRegistered();
                    } else if (currentSection === 'registration') {
                        loadRegistered();
                    } else if (currentSection === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    alert('Error updating status: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status');
            }
        }

        // Move vehicle to detailing
        async function moveToDetailing(vehicleId, queueNumber, plateNumber) {
            if (!confirm(`Apakah Anda yakin ingin memindahkan ${queueNumber} (${plateNumber}) ke antrian Detailing?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/vehicles/${vehicleId}/move-to-detailing`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success notification
                    showNotification(`Kendaraan ${queueNumber} berhasil dipindahkan ke antrian Detailing!`, 'success');
                    
                    // Reload appropriate section
                    if (currentSection === 'queue') {
                        loadRegistered();
                    } else if (currentSection === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    alert('Error: ' + (result.error || 'Gagal memindahkan ke detailing'));
                }
            } catch (error) {
                console.error('Error moving to detailing:', error);
                alert('Error memindahkan ke detailing');
            }
        }

        // Delete vehicle (only for completed vehicles)
        async function deleteVehicle(vehicleId, queueNumber, plateNumber) {
            if (!confirm(`Apakah Anda yakin ingin menghapus antrian ${queueNumber} (${plateNumber}) dari kolom selesai?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/vehicles/${vehicleId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success notification
                    showNotification('Antrian berhasil dihapus dari kolom selesai!', 'success');
                    
                    // Reload appropriate section
                    if (currentSection === 'queue') {
                        loadRegistered();
                    } else if (currentSection === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    alert('Error: ' + (result.error || 'Gagal menghapus antrian'));
                }
            } catch (error) {
                console.error('Error deleting vehicle:', error);
                alert('Error menghapus antrian');
            }
        }

        // Report form
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await loadReportData();
        });

        // Load report data
        async function loadReportData() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const serviceType = document.getElementById('reportServiceType').value;
            
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (serviceType) params.append('service_type', serviceType);
            
            try {
                const response = await fetch(`/api/report/data?${params}`);
                const result = await response.json();
                
                // Show summary
                document.getElementById('reportSummary').style.display = 'block';
                document.getElementById('report-total').textContent = result.summary.total_vehicles;
                document.getElementById('report-cuci').textContent = result.summary.total_cuci;
                document.getElementById('report-detailing').textContent = result.summary.total_detailing;
                document.getElementById('report-avg-time').textContent = result.summary.average_time;
                
                // Show data table
                document.getElementById('reportData').style.display = 'block';
                const tbody = document.querySelector('#reportTable tbody');
                tbody.innerHTML = '';
                
                result.data.forEach(vehicle => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${vehicle.queue_number}</td>
                        <td>${vehicle.plate_number}</td>
                        <td>${vehicle.service_type === 'cuci' ? 'Cuci Mobil' : 'Detailing'}</td>
                        <td><span class="badge badge-${vehicle.status}">${getStatusText(vehicle.status)}</span></td>
                        <td>${formatDateTime(vehicle.created_at, true)}</td>
                        <td>${formatDateTime(vehicle.completed_at)}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading report:', error);
                alert('Error loading report');
            }
        }

        // Export Excel
        document.getElementById('exportExcel').addEventListener('click', () => {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const serviceType = document.getElementById('reportServiceType').value;
            
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (serviceType) params.append('service_type', serviceType);
            
            window.location.href = `/api/report/export?${params}`;
        });

        // Load activity log
        async function loadActivityLog(reset = false) {
            if (reset) activityOffset = 0;
            
            try {
                const response = await fetch(`/api/admin/activity?limit=20&offset=${activityOffset}`);
                const result = await response.json();
                
                const tbody = document.querySelector('#activityTable tbody');
                if (reset) tbody.innerHTML = '';
                
                result.activities.forEach(activity => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${formatDateTime(activity.created_at)}</td>
                        <td>${activity.plate_number ? `${activity.plate_number} (#${activity.queue_number})` : '-'}</td>
                        <td>${activity.action}</td>
                        <td>${activity.description || '-'}</td>
                        <td>${activity.user}</td>
                    `;
                });
                
                activityOffset += result.activities.length;
                
                // Hide load more button if no more data
                if (activityOffset >= result.total) {
                    document.getElementById('loadMoreActivity').style.display = 'none';
                } else {
                    document.getElementById('loadMoreActivity').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Error loading activity log:', error);
            }
        }

        // Load more activity
        document.getElementById('loadMoreActivity').addEventListener('click', () => {
            loadActivityLog(false);
        });

        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/queue/running-text');
                const data = await response.json();
                document.getElementById('runningTextInput').value = data.text;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Update running text
        document.getElementById('runningTextForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const text = document.getElementById('runningTextInput').value;
            
            try {
                const response = await fetch('/api/queue/running-text', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Running text berhasil diupdate');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating running text:', error);
                alert('Error updating running text');
            }
        });

        // Reset queue form
        document.getElementById('resetQueueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('resetPassword').value;
            
            if (!confirm('Apakah Anda yakin ingin mereset nomor antrian? Semua antrian yang belum selesai akan ditandai sebagai selesai.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/reset-queue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Nomor antrian berhasil direset!');
                    document.getElementById('resetQueueForm').reset();
                    // Reload dashboard
                    if (currentSection === 'dashboard') {
                        loadDashboard();
                    }
                } else {
                    alert('Error: ' + (result.error || 'Password salah'));
                }
            } catch (error) {
                console.error('Error resetting queue:', error);
                alert('Error resetting queue');
            }
        });

        // Helper function to get status text
        function getStatusText(status) {
            const statusMap = {
                'waiting': 'Menunggu',
                'washing': 'Cuci',
                'drying': 'Pengeringan',
                'detailing': 'Detailing',
                'completed': 'Selesai'
            };
            return statusMap[status] || status;
        }

        // Helper function untuk format waktu yang konsisten
        function formatDateTime(dateString, addTooltip = false) {
            if (!dateString) return '<span class="timestamp">-</span>';
            
            try {
                const date = new Date(dateString);
                // Validasi tanggal
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date:', dateString);
                    return '<span class="timestamp">Invalid Date</span>';
                }
                
                const formattedDate = date.toLocaleString('id-ID', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Asia/Jakarta' // Pastikan menggunakan timezone Indonesia
                });
                
                const tooltip = addTooltip ? ` title="Waktu pendaftaran akurat (WIB)"` : '';
                return `<span class="timestamp timestamp-accurate"${tooltip}>${formattedDate}</span>`;
            } catch (error) {
                console.error('Error formatting date:', error, dateString);
                return '<span class="timestamp">Error</span>';
            }
        }

        // Socket listeners
        socket.on('queueUpdate', () => {
            if (currentSection === 'dashboard') {
                loadDashboard();
            } else if (currentSection === 'queue') {
                loadRegistered();
            }
        });

        socket.on('dailyReset', (data) => {
            console.log('Daily reset occurred:', data.message);
            // Show notification
            alert('Sistem: Nomor antrian telah direset otomatis untuk hari baru (00:01)');
            // Reload current section
            if (currentSection === 'dashboard') {
                loadDashboard();
            } else if (currentSection === 'queue') {
                loadRegistered();
            } else if (currentSection === 'activity') {
                loadActivityLog(true);
            }
        });

        // Show notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#28a745' : 
                           type === 'error' ? '#dc3545' : 
                           type === 'warning' ? '#ffc107' : '#17a2b8';
            const textColor = type === 'warning' ? '#000' : '#fff';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${bgColor};
                color: ${textColor};
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 9999;
                animation: slideInRight 0.3s ease;
                font-weight: 500;
                max-width: 400px;
                line-height: 1.4;
            `;
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-times-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            notification.innerHTML = `
                <i class="fas ${icon}"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add animation keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Keyboard shortcut to open display view (Ctrl+D or Cmd+D)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                window.open('/', '_blank');
            }
        });

        // Check system time accuracy
        function checkTimeAccuracy() {
            const clientTime = new Date();
            const timezoneOffset = clientTime.getTimezoneOffset();
            const jakartaOffset = -420; // Jakarta is UTC+7 = -420 minutes
            
            if (Math.abs(timezoneOffset - jakartaOffset) > 30) { // More than 30 minutes difference
                showNotification(
                    '⚠️ Peringatan: Timezone sistem mungkin tidak sesuai dengan WIB. ' +
                    'Waktu yang ditampilkan mungkin tidak akurat.', 
                    'warning'
                );
            }
        }

        // Initial load
        loadDashboard();
        
        // Check time accuracy
        setTimeout(checkTimeAccuracy, 2000);
    </script>
</body>
</html>